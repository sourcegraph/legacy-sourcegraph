#!/usr/bin/env bash

# shellcheck disable=SC1090,SC1091
source "$HOME/.profile"

# Fetch the latest origin/main to accurately determine the set of changed
# files on this branch.
echo "Running git fetch --depth 200 --tags"
# need to tell fetch to fetch tags as well otherwise on agents that have a limited depth checkout like aspect, we won't have the tags available
# so after we've done the checkout we'll fetch the tags
#
# depth 200, is 2x of the depth aspect agents checkout by default, so we make sure we get a little more incase a tag is behind the depth boundary
git fetch --depth 200 --tags
echo "Running git fetch... done"

# Link command wrapper scripts so we can have more readable steps in the buildkite UI
ln -s "$(pwd)/dev/ci/scripts/annotated-command.sh" an 2>/dev/null || true

# Provides secrets to the client integration tests target.
echo -e "build --action_env=GH_TOKEN=$GH_TOKEN\nbuild --action_env=PERCY_TOKEN=$PERCY_TOKEN" >.aspect/bazelrc/ci.generated.bazelrc
