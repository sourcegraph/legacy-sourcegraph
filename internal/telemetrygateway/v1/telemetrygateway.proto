syntax = "proto3";

package telemetrygateway.v1;

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/sourcegraph/sourcegraph/internal/telemetrygateway/v1";

service TelemeteryGatewayService {
  // RecordEvents streams telemetry events in batches to the Telemetry Gateway
  // service.
  //
  // Callers should check the attributes of the Event type to ensure that only
  // the appropriate fields are exported.
  rpc RecordEvents(stream RecordEventsRequest) returns (RecordEventsResponse) {}
}

message RecordEventsRequestMetadata {
  // Self-reported identifier for analytics purposes. Currently, this is an
  // analytics prefix and the instance license key hashed together.
  string analytics_identifier = 1;
}

message RecordEventsRequest {
  message Events {
    repeated Event events = 1;
  }

  oneof payload {
    // Metadata about the events being recorded.
    RecordEventsRequestMetadata metadata = 1;
    // Events to record in a single request. Clients should aim to batch large
    // event backlogs into a series of smaller requests each <1MB in size in the
    // RecordEvents stream, e.g. using (google.golang.org/protobuf/proto).Size(...).
    Events events = 2;
  }
}

message RecordEventsResponse {}

message Event {
  // Generated ID of the event, currently expected to be UUID v4.
  string id = 1;
  // Timestamp of when the original event was recorded.
  google.protobuf.Timestamp timestamp = 2;
  // Feature associated with the event in camelCase, e.g. 'myFeature'.
  string feature = 3;
  // Action associated with the event in camelCase, e.g. 'pageView'.
  string action = 4;
  // Source of the event.
  EventSource source = 5;
  // Parameters of the event.
  EventParameters parameters = 6;
  // Optional user associated with the event.
  //
  // This field should be hydrated by the Sourcegraph server, and not provided
  // by clients.
  optional EventUser user = 7;
  // Optional feature flags configured in the context of the event.
  optional EventFeatureFlags feature_flags = 8;
  // Optional marketing campaign tracking parameters.
  //
  // ðŸš¨ SECURITY: Do NOT export this metadata by default, as it can contain
  // sensitive data. Currently, only Sourcegraph.com should export this.
  optional EventMarketingTracking marketing_tracking = 9;
}

message EventSource {
  message Server {
    string version = 1;
  }
  message Client {
    string name = 1;
    optional string version = 2;
  }

  // Information about the Sourcegraph instance that received the event.
  Server server = 1;
  // Information about the client that generated the event.
  optional Client client = 2;
}

message EventParameters {
  // Version of the event parameters, used for indicating the "shape" of this
  // event's metadata, beginning at 0.
  int32 version = 1;
  // Strictly typed metadata, restricted to integer values.
  map<string, int64> metadata = 2;
  // Additional potentially sensitive metadata - i.e. not restricted to integer
  // values.

  // ðŸš¨ SECURITY: Do NOT export this metadata by default, as it can contain
  // arbitrarily-shaped data that may accidentally contain sensitive contents.
  //
  // This should only be exported on an allowlist basis based on combinations
  // of event feature and action, alongside careful audit of callsites.
  optional google.protobuf.Struct private_metadata = 3;
  // Optional billing-related metadata.
  optional EventBillingMetadata billing_metadata = 4;
}

message EventBillingMetadata {
  // Billing product ID associated with the event.
  string product = 1;
  // Billing category ID the event falls into.
  string category = 2;
}

message EventUser {
  // Database user ID of signed in user.
  //
  // We use an int64 as an ID because in Sourcegraph, database user IDs are
  // always integers.
  optional int64 user_id = 1;
  // Randomized unique identifier for client (i.e. stored in localstorage in web
  // client).
  optional string anonymous_user_id = 2;
}

message EventFeatureFlags {
  // Evaluated feature flags. In Soucegraph we currently only support boolean
  // feature flags, but in the API we allow arbitrary string values for future
  // extensibility.
  //
  // This field should be hydrated by the Sourcegraph server, and not provided
  // by clients.
  map<string, string> flags = 1;
}

message EventMarketingTracking {
  optional string url = 1;
  optional string first_source_url = 2;
  optional string cohort_id = 3;
  optional string referrer = 4;
  optional string last_source_url = 5;
  optional string device_session_id = 6;
  optional string session_referrer = 7;
  optional string session_first_url = 8;
}
