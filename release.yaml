meta:
  productName: sourcegraph
  repository: "github.com/sourcegraph/sourcegraph"
  owners:
    - "@sourcegraph/release"

requirements:
  - name: "curl"
    cmd: "curl --help"
  - name: "Buidkite access token"
    env: BUILDKITE_ACCESS_TOKEN

internal:
  create:
    steps:
      patch:
        - name: "Create Buildkite Build"
          cmd: |
            curl -v -X POST "https://api.buildkite.com/v2/organizations/sourcegraph/pipelines/sourcegraph/builds" -H "Content-Type: application/json" -H "Authorization: Bearer $BUILDKITE_ACCESS_TOKEN" -d '{
                "commit": "HEAD",
                "branch": "rfc795/main",
                "message": "Internal release build for {{version}}",
                "env": {
                  "RELEASE_INTERNAL": "true",
                  "VERSION": "{{tag}}"
                }
              }'
  finalize:
    steps:
      - name: "Register on release registry"
        cmd: |
          echo "pretending to call release registry api"

test:
  steps:
    - name: "placeholder"
      cmd: |
        echo "-- pretending to test release ..."

promoteToPublic:
  create:
    steps:
      - name: "Creating build"
        cmd: |
          curl --fail-with-body -X POST "https://api.buildkite.com/v2/organizations/sourcegraph/pipelines/sourcegraph/builds" -H "Content-Type: application/json" -H "Authorization: Bearer $BUILDKITE_ACCESS_TOKEN" -d '{
              "commit": "HEAD",
              "branch": "rfc795/main",
              "message": "Promoting internal release {{version}} to public",
              "env": {
                "RELEASE_PUBLIC": "true",
                "VERSION": "{{tag}}"
              }
            }'
  finalize:
    steps:
      - name: "Register on release registry"
        cmd: |
          echo "pretending to call release registry api"
